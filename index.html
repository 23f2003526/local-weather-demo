<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>City Weather - Open-Meteo</title>
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeo7F6AHMGn5QD6N5Dk6MZ6E+ogmHZv+hNeJo0ieGizqPLForn"
    crossorigin="anonymous"
  />
  <style>
    body {
      background: #f8f9fa;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .weather-card {
      max-width: 400px;
      width: 100%;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.1);
      background: white;
    }
  </style>
</head>
<body>
  <div class="weather-card">
    <h2 class="mb-4 text-center">Check Current Weather</h2>
    <form id="weather-form" class="mb-3" autocomplete="off">
      <div class="mb-3">
        <label for="city-input" class="form-label">City Name</label>
        <input
          type="text"
          class="form-control"
          id="city-input"
          placeholder="Enter city name"
          required
        />
      </div>
      <button type="submit" class="btn btn-primary w-100">Get Weather</button>
    </form>
    <div id="result" class="text-center"></div>
  </div>

  <script>
    // Fetch coordinates from geocoding API (Open-Meteo)
    async function getCoordinates(city) {
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error("Geocoding API error");
      }
      const data = await response.json();
      if (!data.results || data.results.length === 0) {
        throw new Error("City not found");
      }
      return {
        latitude: data.results[0].latitude,
        longitude: data.results[0].longitude,
        name: data.results[0].name,
        country: data.results[0].country,
      };
    }

    // Fetch current weather
    async function getWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relative_humidity_2m`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error("Weather API error");
      }
      const data = await response.json();
      return data;
    }

    function findHumidityForCurrentHour(hourly, currentTime) {
      // hourly.time is an array of ISO strings (UTC)
      // currentTime is in UTC (ISO string)
      const idx = hourly.time.findIndex(t => t === currentTime);
      return idx !== -1 ? hourly.relative_humidity_2m[idx] : null;
    }

    document.getElementById("weather-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";
      const cityName = document.getElementById("city-input").value.trim();
      if (!cityName) return;
      resultDiv.innerHTML =
        '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

      try {
        // Get city coordinates
        const location = await getCoordinates(cityName);

        // Get weather data
        const weatherData = await getWeather(location.latitude, location.longitude);
        const currentWeather = weatherData.current_weather;
        if (!currentWeather) throw new Error("Current weather data unavailable");

        // Find humidity for the exact current hour (UTC)
        const hourly = weatherData.hourly;
        let humidity = null;

        // Determine UTC current hour in ISO string format truncated to hour (YYYY-MM-DDTHH:00)
        const currentUTCDate = new Date(currentWeather.time + "Z");
        const currentHourISO = currentUTCDate.toISOString().slice(0, 13) + ":00";

        humidity = findHumidityForCurrentHour(hourly, currentHourISO);
        if (humidity === null) {
          humidity = "N/A";
        } else {
          humidity += "%";
        }

        // Show results
        resultDiv.innerHTML = `
          <div class="card border-primary">
            <div class="card-body">
              <h5 class="card-title mb-3">${location.name}, ${location.country}</h5>
              <p class="card-text mb-2">Temperature: <strong>${currentWeather.temperature.toFixed(1)}Â°C</strong></p>
              <p class="card-text mb-0">Humidity: <strong>${humidity}</strong></p>
            </div>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger" role="alert">${error.message}</div>`;
      }
    });
  </script>
</body>
</html>